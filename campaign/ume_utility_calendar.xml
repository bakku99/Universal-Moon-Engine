<?xml version="1.0" encoding="utf-8"?>
<root version="4.1">

  <!-- ===================================================== -->
  <!-- Merge into CALENDAR_MAIN_DATE for phase display       -->
  <!-- ===================================================== -->
  <mergeclass name="calendar_main_date">
    <sheetdata>
      <!-- Label under the main date string -->
      <stringcontrol name="ume_moon_label">
        <anchored>
          <top relative="viewdate" offset="20" />
          <left offset="30" />
          <width>50</width>
        </anchored>
        <static text="Moon:" />
        <font>sheetlabel</font>
      </stringcontrol>

      <!-- Phase icon -->
      <iconcontrol name="ume_moon_icon">
        <anchored>
          <top relative="ume_moon_label" />
          <left relative="ume_moon_label" offset="50" />
          <size width="20" height="20" />
        </anchored>
        <icon>ume_moon_phase_1</icon>
      </iconcontrol>

      <!-- Phase text -->
      <stringcontrol name="ume_moon_text">
        <anchored>
          <top relative="ume_moon_label" offset="2" />
          <left relative="ume_moon_icon" offset="5" />
          <right offset="-30" />
          <height>20</height>
        </anchored>
        <font>sheettext</font>
      </stringcontrol>

      <script>
		local function getPrimaryMoonNode()
		  if not UniversalMoonEngine or not UniversalMoonEngine.getActiveCalendarKey then
			return nil;
		  end

		  local sKey = UniversalMoonEngine.getActiveCalendarKey();
		  local nodeMoons = DB.findNode("ume.calendars." .. sKey .. ".moons");
		  if not nodeMoons then
			return nil;
		  end

		  local aMoons = DB.getChildList(nodeMoons);
		  if not aMoons or #aMoons == 0 then
			return nil;
		  end

		  -- For now: just use the first moon node.
		  return aMoons[1];
		end

        function updateMoonDisplay()
          if not UniversalMoonEngine then
            ume_moon_text.setValue("");
            return;
          end

          local nodeMoon = getPrimaryMoonNode();
          if not nodeMoon then
            ume_moon_text.setValue("No moons configured");
            ume_moon_icon.setIcon("ume_moon_phase_1");
            return;
          end

          local nIndex = UniversalMoonEngine.computePhase(nodeMoon, UniversalMoonEngine.getCurrentDayIndex());
          local sPhase = UniversalMoonEngine.getPhaseName(nIndex);
          local sIcon  = UniversalMoonEngine.getPhaseIconName(nIndex);

          ume_moon_text.setValue(sPhase);
          if sIcon then
            ume_moon_icon.setIcon(sIcon);
          end
        end

        function onInit()
          DB.addHandler("calendar.current.day", "onUpdate", updateMoonDisplay);
          DB.addHandler("calendar.current.month", "onUpdate", updateMoonDisplay);
          DB.addHandler("calendar.current.year", "onUpdate", updateMoonDisplay);
          updateMoonDisplay();
        end

        function onClose()
          DB.removeHandler("calendar.current.day", "onUpdate", updateMoonDisplay);
          DB.removeHandler("calendar.current.month", "onUpdate", updateMoonDisplay);
          DB.removeHandler("calendar.current.year", "onUpdate", updateMoonDisplay);
        end
      </script>
    </sheetdata>
  </mergeclass>

  <!-- ===================================================== -->
  <!-- Merge into CALENDAR_MAIN_BUTTONS for manager button   -->
  <!-- ===================================================== -->
  <mergeclass name="calendar_main_buttons">
    <sheetdata>
      <!-- Add a Moon Manager button to the bottom button bar -->
      <button_text name="ume_button_moonmanager">
        <!-- Core has button_viewall anchored insidetopright offset="20,5" width="120".
             We anchor further in (140,5) so ours appears just to the LEFT of that. -->
        <anchored position="insidetopright" offset="140,5" width="120" />
        <state text="Moon Manager" />
        <tooltip text="Configure Universal Moon Engine moons for this calendar" />
        <script>
          function onButtonPress()
            Interface.openWindow("ume_moon_manager", "");
          end
        </script>
      </button_text>
    </sheetdata>
  </mergeclass>

</root>
