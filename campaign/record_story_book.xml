<?xml version="1.0" encoding="iso-8859-1"?>

<!--
	Please see the license.html file included with this distribution for
	attribution and copyright information.
-->

<root>
	<windowclass name="story_book_list">
		<frame>referencelist</frame>
		<sizelimits>
			<minimum width="400" height="400" />
			<dynamic />
		</sizelimits>
		<minimize>minimized_reference</minimize>
		<script file="campaign/scripts/story_book_list.lua" />
		<sheetdata>
			<windowtitlebar_referencelist name="title">
				<resource>library_recordtype_label_story_book</resource>
			</windowtitlebar_referencelist>
			<windowmenubar_referencelist name="menubar" />

			<anchor_content_referencelist_top />
			<anchor_content_referencelist_bottom />

			<area_content_top name="area_buttons">
				<anchored height="30" />
				<gmvisibleonly />
			</area_content_top>
			<button_text_sm name="button_campaign">
				<anchored to="area_buttons" position="insidetopleft" offset="5,5" width="80" />
				<state textres="campaign" />
				<gmvisibleonly />
				<script>
					function onButtonPress()
						StoryManager.openBook();
					end
				</script>
			</button_text_sm>

			<filter_content_bottom name="filter" />
			<sub_content_framed_groupbox_hidden_bottom name="notes" />
			<sub_content_paging name="sub_paging" />

			<list_content_framed_groupbox_alternating name="list">
				<class>story_book_list_item</class>
				<sortby><control>name</control></sortby>
				<readonly />
			</list_content_framed_groupbox_alternating>
			<scrollbar_content_list />

			<resize_referencelist />
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_list_item">
		<margins control="0,0,0,2" />
		<script>
			function setData(v)
				name.setValue(v.sDisplayName);
				link.setValue("reference_manual", DB.getPath(v.node));
			end
		</script>
		<sheetdata>
			<anchor_listitem_left_sm />
			<anchor_listitem_right_sm />

			<linkc_listitem_left name="link">
				<description control="name" merge="replace" />
			</linkc_listitem_left>
			<stringc_listitem_center_noframe_static_linked name="name" />
		</sheetdata>
	</windowclass>

	<windowclass name="reference_manual">
		<frame>utilitybox</frame>
		<placement>
			<size width="1000" height="650" />
		</placement>
		<sizelimits>
			<minimum width="440" height="300" />
			<dynamic />
		</sizelimits>
		<minimize>minimized_reference</minimize>
		<windowmenu>
			<showlink />
		</windowmenu>
		<script>
			function onInit()
				StoryManager.performBookDisplayInit(self);
			end
			function onClose()
				StoryManager.performBookDisplayClose(self);
			end
			function handleSectionPrev()
				StoryManager.handleSectionPrev(self);
			end
			function handleSectionNext()
				StoryManager.handleSectionNext(self);
			end
		</script>
		<sheetdata>
			<windowtitlebar_utilitybox name="title" />
			<windowmenubar_utilitybox name="menubar" />

			<anchor_content_utilitybox_top />
			<anchor_content_utilitybox_bottom />

			<area_content_bottom name="area_controls">
				<anchored height="30" />
			</area_content_bottom>
			<spacer_content_bottom name="spacer_bottom" />

			<anchor_story_book_index name="anchor_index" />

			<frame_story_book_index name="frame_index" />
			<sub_story_book_index name="sub_index" />
			<scrollbar_story_book_index name="scrollbar_index" />

			<filter_story_book_index name="filter" />

			<button_story_book_index_show name="button_index_show" />

			<frame_story_book_content name="frame_content" />
			<sub_story_book_content name="content" />

			<sub_story_book_paging name="sub_paging" />

			<scrollbar_content />
			<resize_utilitybox />
		</sheetdata>
	</windowclass>

	<template name="story_book_index_empty">
		<stringcontrol>
			<anchored>
				<top anchor="center" offset="-10" />
				<left />
				<right />
			</anchored>
			<font>list-empty</font>
			<static textres="story_book_index_empty" />
			<center />
		</stringcontrol>
	</template>

	<windowclass name="story_book_index">
		<script>
			function onInit()
				self.onLockModeChanged(WindowManager.getReadOnlyState(getDatabaseNode()));
			end
			function onLockModeChanged(bReadOnly)
				StoryManager.performBookIndexLockModeChanged(WindowManager.getTopWindow(self));

				WindowManager.callSafeControlsSetVisible(self, { "list_iadd", "spacer", }, not bReadOnly);
				if bReadOnly and (DB.getModule(getDatabaseNode()) == "") then
					StoryManager.onBookKeywordGen();
				end
			end
			function onDrop(x, y, draginfo)
				return StoryManager.onBookIndexDrop(self, draginfo);
			end
		</script>
		<sheetdata>
			<anchor_content_top />

			<list_story_book_index_chapters name="list" />

			<button_story_book_index_iadd name="list_iadd">
				<state textres="story_book_index_button_chapter_new" />
			</button_story_book_index_iadd>
			<spacer_content_top name="spacer" />

			<story_book_index_empty name="label_empty" />

			<toolbar_anchor_right />
			<toolbar_field_right name="locked">
				<initbyname />
				<script>
					function notify()
						if self.isInitialized() then
							WindowManager.callInnerWindowFunction(window, "onLockModeChanged", (getValue() == 1));
						end
					end
				</script>
			</toolbar_field_right>
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_index_chapter">
		<script>
			function onInit()
				self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
			end
			function onLockModeChanged(bReadOnly)
				WindowManager.callSafeControlsSetLockMode(self, { "name", "idelete", "imoveup", "imovedown", }, bReadOnly);
				WindowManager.callSafeControlsSetVisible(self, { "list_iadd", "spacer", }, not bReadOnly);
			end
			function showFullHeaders(bShow)
				frame.setVisible(bShow);
				name.setVisible(bShow);
			end
			function onDrop(x, y, draginfo)
				return StoryManager.onBookIndexDrop(self, draginfo);
			end
		</script>
		<sheetdata>
			<hnc name="hidden" />
			
			<anchor_content_top />

			<frame_story_book_index_chapter name="frame" />
			<anchor_story_book_index_chapter_left name="leftanchor" />
			<anchor_story_book_index_chapter_right name="rightanchor" />

			<button_story_book_index_idelete name="idelete" />

			<button_story_book_index_imoveup name="imoveup" />
			<button_story_book_index_imovedown name="imovedown" />

			<string_story_book_index_chapter_name name="name" />

			<list_story_book_index_sections name="list" />

			<button_story_book_index_iadd name="list_iadd">
				<state textres="story_book_index_button_section_new" />
			</button_story_book_index_iadd>
			<spacer_content_top name="spacer" />
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_index_section">
		<script>
			function onInit()
				self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
			end
			function onLockModeChanged(bReadOnly)
				WindowManager.callSafeControlsSetLockMode(self, { "name", "idelete", "imoveup", "imovedown", }, bReadOnly);
				WindowManager.callSafeControlsSetVisible(self, { "list_iadd", "spacer", }, not bReadOnly);
			end
			function showFullHeaders(bShow)
				frame.setVisible(bShow);
				name.setVisible(bShow);
			end
			function onDrop(x, y, draginfo)
				return StoryManager.onBookIndexDrop(self, draginfo);
			end
		</script>
		<sheetdata>
			<hnc name="hidden" />
			
			<anchor_content_top />

			<frame_story_book_index_section name="frame" />
			<anchor_story_book_index_section_left name="leftanchor" />
			<anchor_story_book_index_section_right name="rightanchor" />

			<button_story_book_index_idelete name="idelete" />

			<button_story_book_index_imoveup name="imoveup" />
			<button_story_book_index_imovedown name="imovedown" />

			<string_story_book_index_section_name name="name" />

			<list_story_book_index_pages name="list" />

			<button_story_book_index_iadd name="list_iadd">
				<state textres="story_book_index_button_page_new" />
			</button_story_book_index_iadd>
			<spacer_content_top name="spacer" />
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_index_page">
		<margins control="0,0,0,2" />
		<script>
			function onInit()
				self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
			end
			function onLockModeChanged(bReadOnly)
				WindowManager.callSafeControlsSetLockMode(self, { "name", "idelete", "imoveup", "imovedown", }, bReadOnly);
			end
			function setLink(sClass, sRecord)
				listlink.setValue(sClass, sRecord);
				name.updateLink();
				StoryIndexManager.rebuildBookIndex(DB.getModule(getDatabaseNode()));
			end
			function onDrop(x, y, draginfo)
				return StoryManager.onBookIndexDrop(self, draginfo);
			end
			local _bHighlight = false;
			function setHighlight(bHighlight)
				if bHighlight == _bHighlight then
					return;
				end
				_bHighlight = bHighlight;
				setFrame(bHighlight and "rowshade" or nil);
				if not windowlist.isVisible() then
					windowlist.setVisible(true);
				end
			end
		</script>
		<sheetdata>
			<hnc name="hidden" />
			
			<hlink name="listlink" />
			<hs name="keywords" />

			<anchor_content_top />

			<frame_story_book_index_page name="frame" />
			<anchor_story_book_index_page_left name="leftanchor" />
			<anchor_story_book_index_page_right name="rightanchor" />

			<button_story_book_index_idelete name="idelete" />
			<spacer_listitem_left name="spacer_indent" />

			<button_story_book_index_imoveup name="imoveup" />
			<button_story_book_index_imovedown name="imovedown" />

			<string_story_book_index_page_name name="name" />
		</sheetdata>
	</windowclass>

	<windowclass name="story_book_section">
		<sheetdata>
			<anchor_content_top />
			<anchor_content_bottom />

			<list_content name="list">
				<class>story_book_page_entry</class>
				<sortby><field>order</field></sortby>
				<script>
					local _sPath = "";
					local _nChunk = 0;
					function getData()
						return _sPath, _nChunk;
					end
					function setData(sPath, nChunk)
						_sPath = sPath;
						_nChunk = nChunk;
					end
					function onScroll()
						StoryManager.handleBookScroll(WindowManager.getTopWindow(window));
					end
				</script>
			</list_content>
			<scrollbar_list />
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_page_entry">
		<script>
			function onInit()
				self.onLinkChanged();
			end
			function onLinkChanged()
				local sClass,sRecord = listlink.getValue();
				if sClass == "encounter" then
					content.setValue("story_book_page_simple", sRecord);
				else
					content.setValue("story_book_page_advanced", sRecord);
				end
			end
		</script>
		<sheetdata>
			<hlink name="listlink">
				<script>
					function onValueChanged()
						window.onLinkChanged();
					end
				</script>
			</hlink>

			<anchor_content_top />
			<sub_content_top name="content" />
		</sheetdata>
	</windowclass>

	<template name="story_book_page_locked">
		<toolbar_field_header_right name="locked">
			<script>
				function notify()
					if self.isInitialized() then
						WindowManager.callInnerWindowFunction(window.parentcontrol.window, "onLockModeChanged", (getValue() == 1));
					end
				end
			</script>
		</toolbar_field_header_right>
	</template>

	<windowclass name="story_book_page_simple">
		<script file="common/scripts/record_window.lua" />
		<sheetdata>
			<anchor_content_top />

			<sub_content_top name="header">
				<class>story_book_page_simple_header</class>
			</sub_content_top>
			<sub_content_top name="content">
				<class>record_content_text</class>
			</sub_content_top>
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_page_simple_header" copy="record_header_story">
		<sheetdata>
			<linkc_record_header name="pagelink" insertbefore="name">
				<class>encounter</class>
			</linkc_record_header>

			<story_book_page_locked name="locked" insertbefore="name" />
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_page_advanced">
		<script file="common/scripts/record_window.lua" />
		<sheetdata>
			<anchor_content_top />

			<sub_content_top name="header">
				<class>story_book_page_advanced_header</class>
			</sub_content_top>
			<sub_content_top name="content">
				<class>story_content_advanced</class>
			</sub_content_top>
		</sheetdata>
	</windowclass>
	<windowclass name="story_book_page_advanced_header" copy="story_header_advanced">
		<sheetdata>
			<linkc_record_header name="pagelink" insertbefore="name">
				<class>referencemanualpage</class>
			</linkc_record_header>

			<story_book_page_locked name="locked" insertbefore="story_paste" />
		</sheetdata>
	</windowclass>
	<windowclass name="reference_manualtextwide" copy="story_book_page_advanced" />

	<windowclass name="record_paging_story_book">
		<sheetdata>
			<button_icon name="section_prev">
				<anchored>
					<top anchor="center" offset="-10" />
					<right anchor="center" offset="-40" />
				</anchored>
				<state icon="button_toolbar_arrow_w" tooltipres="story_book_tooltip_section_prev" />
				<tintable />
				<invisible />
				<script>
					function onButtonPress()
						WindowManager.callOuterWindowFunction(window, "handleSectionPrev");
						return true;
					end
				</script>
			</button_icon>
			<button_icon name="section_next">
				<anchored>
					<top anchor="center" offset="-10" />
					<left anchor="center" offset="40" />
				</anchored>
				<state icon="button_toolbar_arrow_e" tooltipres="story_book_tooltip_section_next" />
				<tintable />
				<invisible />
				<script>
					function onButtonPress()
						WindowManager.callOuterWindowFunction(window, "handleSectionNext");
						return true;
					end
				</script>
			</button_icon>
		</sheetdata>
	</windowclass>
</root>
